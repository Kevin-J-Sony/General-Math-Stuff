#include <stdio.h>
#include <stdlib.h>
#include <time.h>

typedef struct {
	int* m;
	int row_size, col_size;
} matrix;


void free_mat(matrix* m) {
	for (int i = 0; i < m->row_size; i++) {
		free(m->m[i]);
	}
	free(m->m);
	free(m);
}

// take two matrices m1, m2, and return the result of these two multiplied
// if the matrices are not of correct size, output a statement and return
// the first matrix.
matrix* multiply(matrix* m1, matrix* m2) {
	if (m1->col_size != m2->row_size) {
		fprintf(stdout, "Dimensions do not match");
		return (matrix*)NULL;
	}
	int f_row_size = m1->row_size;
	int f_col_size = m2->col_size;
	int middle = m1->col_size;

	int* mat1 = m1->m;
	int* mat2 = m2->m;
	int* mat3 = (int*)malloc(sizeof(int) * f_row_size * f_col_size);

	for (int i = 0; i < f_row_size; i++) {
		for (int j = 0; j < f_col_size; j++) {
			mat3[i * f_row_size + j] = 0;
			for (int k = 0; k < middle; k++) {
				mat3[i * f_row_size + j] += mat1[i * f_row_size + k] * mat2[k * middle + j];
			}
		}
	}

	matrix* m3 = (matrix*)malloc(sizeof(matrix));
	m3->m = mat3;
	m3->row_size = m1->row_size;
	m3->col_size = m2->col_size;
	return m3;
}

int main() {
	// int N[5] = {100, 200, 500, 1000, 1500};	
	int N[5] = {100, 200, 500, 500, 500};
		
	FILE *file_pointer = fopen("simple_matrix_mult_data.txt", "w+");
	for (int s = 0; s < 5; s++) {
		// LOOP 10 TIMES TO GET CONSISTENT DATA
		double ms = 0;
		for (int t = 0; t < 10; t++) {
			matrix* m1 = (matrix*)malloc(sizeof(matrix));
			matrix* m2 = (matrix*)malloc(sizeof(matrix));
			m1->row_size = N[s], m1->col_size = N[s]+1;
			m2->row_size = N[s]+1, m2->col_size = N[s];

			int* matrix1 = (int*)malloc(sizeof(int) * m1->row_size * m1->col_size);
			for (int i = 0; i < m1->row_size; i++) {
				for (int j = 0; j < m1->col_size; j++) {
					matrix1[i * m1->row_size + j] = 1;
				}
			}

			int* matrix2 = (int*)malloc(sizeof(int) * m2->row_size * m2->col_size);
			for (int i = 0; i < m2->row_size; i++) {
				for (int j = 0; j < m2->col_size; j++) {
					matrix2[i * m2->row_size + j] = 1;
				}
			}
			m1->m = matrix1;
			m2->m = matrix2;
			
			clock_t start = clock();
			matrix* m3 = multiply(m1, m2);
			clock_t end = clock();
			ms += (end - start) * 1000 / CLOCKS_PER_SEC;
			printf("time in milliseconds: %f\n", ms);

			/*
			for (int i = 0; i < m3->row_size; i++) {
				for (int j = 0; j < m3->col_size; j++) {
					fprintf(stdout, "%i ", m3->m[i][j]);
				}
				fprintf(stdout, "\n");
			}
			*/

			free_mat(m1);
			free_mat(m2);
			free_mat(m3);
		}
		fprintf(file_pointer, "Average time to multiply (%d x %d) and (%d x %d) in milliseconds: %f\n", N[s], N[s]+1, N[s]+1, N[s], ms); 
	}
	fclose(file_pointer);
	return 0;
}
